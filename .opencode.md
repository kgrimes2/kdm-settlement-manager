# OpenCode Configuration

This file provides instructions and preferences for the OpenCode AI assistant when working on this project.

## Project Information

**Project Name:** KDM Settlement Manager  
**Type:** React + TypeScript web application  
**Package Manager:** npm  
**Testing Framework:** Vitest with React Testing Library  
**Build Tool:** Vite  

## Code Style & Standards

### General
- Use TypeScript strict mode
- Prefer functional components with hooks over class components
- Use meaningful variable names (no single-letter variables except for common iterators)
- Add JSDoc comments for complex functions
- Keep functions small and focused (single responsibility)

### File Organization
- Components in `src/` directory
- Tests co-located with source files (`*.test.tsx`)
- CSS files co-located with components (`*.css`)
- Types in `src/types/` directory

### Naming Conventions
- Components: PascalCase (e.g., `SurvivorSheet.tsx`)
- Files: PascalCase for components, camelCase for utilities
- Functions: camelCase
- Constants: UPPER_SNAKE_CASE
- CSS classes: kebab-case

## Development Workflow

### When Making Changes

1. **Always run tests before committing**
   ```bash
   npm test -- [ComponentName] --run
   ```

2. **Always check TypeScript compilation**
   ```bash
   npx tsc -b
   ```

3. **Update tests when changing functionality**
   - If you modify a component's behavior, update or add tests
   - Ensure all existing tests still pass
   - Add new test cases for bug fixes to prevent regression

4. **Update CHANGELOG.md for every user-facing change**
   - Follow [Keep a Changelog](https://keepachangelog.com/) format
   - Add entries under `## [Unreleased]` section
   - Categories: Added, Changed, Deprecated, Removed, Fixed, Security
   - Be specific and user-focused in descriptions

5. **Version bumping**
   - When bumping version, update ALL of these:
     - `package.json` (use `npm version X.Y.Z --no-git-tag-version`)
     - `package-lock.json` (automatically updated by npm version)
     - `src/App.tsx` - `APP_VERSION` constant
     - `CHANGELOG.md` - Move Unreleased items to new version section with date

### Git & PR Workflow

#### Branch Naming
- Features: `feat/description-of-feature`
- Fixes: `fix/description-of-bug`
- Documentation: `docs/description`
- Chores: `chore/description`

#### Commit Messages
Follow [Conventional Commits](https://www.conventionalcommits.org/):
- `feat:` - New feature
- `fix:` - Bug fix
- `docs:` - Documentation changes
- `chore:` - Maintenance tasks (version bumps, deps)
- `refactor:` - Code refactoring
- `test:` - Test updates
- `style:` - Code style changes (formatting, no logic changes)

Examples:
```
fix: prevent NumericInput overlay from triggering underlying elements
feat: add survivor export functionality
docs: update API documentation for sync endpoints
chore: bump version to 1.3.2
```

#### Pull Request Process
1. Create a feature branch from `main`
2. Make changes and commit with conventional commit messages
3. Ensure all tests pass and TypeScript compiles
4. Update CHANGELOG.md
5. Update version if releasing (all locations)
6. Push branch to origin
7. Create PR with descriptive title and body:
   ```markdown
   ## Summary
   Brief description of changes
   
   ## Changes
   - Bullet list of specific changes
   
   ## Testing
   - How changes were tested
   ```

### Testing Guidelines

#### When to Update Tests
- **Always** update tests when fixing bugs
- **Always** add tests for new features
- Update tests when changing component behavior
- Add regression tests for bugs to prevent recurrence

#### Test Structure
```typescript
describe('ComponentName', () => {
  it('should describe expected behavior', async () => {
    // Arrange
    const user = userEvent.setup()
    render(<Component {...props} />)
    
    // Act
    await user.click(screen.getByRole('button'))
    
    // Assert
    expect(screen.getByText('result')).toBeInTheDocument()
  })
})
```

#### What to Test
- User interactions (clicks, typing, etc.)
- Component rendering with different props
- State changes and updates
- Error states
- Edge cases

#### What NOT to Test
- Implementation details
- Third-party library internals
- CSS styling (unless functional)

### CHANGELOG Guidelines

#### Format
```markdown
## [Unreleased]

## [X.Y.Z] - YYYY-MM-DD

### Added
- New features

### Changed
- Changes to existing functionality

### Fixed
- Bug fixes with clear description of issue and solution

### Security
- Security-related changes
```

#### Writing Good CHANGELOG Entries
- Be specific and user-focused
- Explain WHAT changed and WHY it matters to users
- Include technical details in sub-bullets if helpful
- Link to issues/PRs when relevant
- Use past tense ("Fixed" not "Fix")

Example:
```markdown
### Fixed
- **NumericInput overlay click-through bug** - Clicking anywhere while +1/-1 buttons are visible now only closes the buttons without triggering the clicked element
  - Added `preventDefault()` and `stopPropagation()` to overlay click handlers
  - Overlay now completely blocks all page interactions while buttons are visible
  - Prevents accidental checkbox toggles and input focus when closing buttons
```

## Automation Preferences

### Automatic Actions
When making changes, automatically:
- âœ… Run relevant tests after code changes
- âœ… Check TypeScript compilation
- âœ… Update CHANGELOG.md under `[Unreleased]` section
- âœ… Update or add tests for bug fixes and new features
- âœ… Format code consistently with existing style

### Manual Confirmation Required
Ask before:
- Creating git commits
- Pushing to remote
- Creating pull requests
- Bumping version numbers
- Deleting or renaming files
- Making breaking changes
- Modifying infrastructure/deployment files

### When Fixing Bugs
1. Reproduce the issue (understand the problem)
2. Write or update tests that demonstrate the bug
3. Fix the bug
4. Verify tests pass
5. Update CHANGELOG.md with clear description
6. Ask user to verify the fix before committing

## Token Usage Tracking

### Automatic Reporting
Report token usage automatically at these points:
- **After completing each major task** (commits, PRs, large code changes)
- **At usage milestones**: 50%, 75%, and 90% of session budget
- **When directly asked** by the user

### Report Format
Use this consistent format at the END of every response:
```
ðŸ“Š Session: XXX,XXX tokens used ($X.XX) | Total: $X.XX
```

**Example:**
```
ðŸ“Š Session: 120,500 tokens used ($0.36) | Total: $1.24
```

### Detailed Report Format (when milestones are hit)
When reaching usage milestones (50%, 75%, 90%), provide detailed breakdown:
```
ðŸ“Š Token Usage: XX,XXX / 200,000 (XX.X%)
   Remaining: XXX,XXX tokens
   Status: [On Track | High Usage | Approaching Limit]
   
ðŸ’° This Session: $X.XX
   Running Total: $X.XX (across all sessions)
```

### Tracking the Running Total
- Maintain a cumulative total across all sessions
- Start tracking from: 2026-02-11 (initial session: $0.36)
- Include session cost + running total in EVERY response
- Update the total as the session progresses

### Pricing Information
**Model:** Claude Sonnet 4.5 via Amazon Bedrock  
**Input tokens:** $3.00 per million tokens  
**Output tokens:** $15.00 per million tokens  

**Note:** Actual costs may vary by region. These estimates use standard US region pricing. Sessions use primarily input tokens (reading code, processing context) with minimal output tokens (responses, code generation).

### Status Definitions
- **On Track** - Less than 50% used
- **High Usage** - 50-75% used
- **Approaching Limit** - 75-90% used  
- **Critical** - Over 90% used

### What Affects Token Usage
High token usage typically comes from:
- Multiple iterations on complex problems
- Extensive code reading/searching
- Creating comprehensive documentation
- Debugging and troubleshooting
- Multiple PR creation attempts

Lower token usage for:
- Simple bug fixes with clear solution
- Direct code changes to known files
- Straightforward feature additions
- Documentation updates

## Project-Specific Notes

### Temporary Files & Documentation
**IMPORTANT:** All temporary files created during development must go in the `.temp/` directory:
- Test HTML files
- Debug scripts
- Temporary documentation
- Notes and scratch files
- Any file not intended for version control

The `.temp/` directory is ignored by git. Never create temporary files in the root or other tracked directories.

**Examples:**
```
âœ… .temp/test-numeric-input.html
âœ… .temp/debug-notes.md
âœ… .temp/api-test.js
âŒ test-numeric-checkbox.html (root directory)
âŒ public/test-numeric.html (tracked directory)
```

### NumericInput Component
- Has +1/-1 buttons that appear on click
- Overlay should block all page interactions when buttons visible
- Touch support required (mobile-friendly)
- Tests may not accurately simulate z-index layering (manual browser testing needed)

### Survivor Sheet
- Main component for managing Kingdom Death Monster survivors
- Attributes can be negative (no min constraints)
- Uses NumericInput for all numeric fields
- Heavy use of checkboxes and state management

### Version Numbering
- Follow Semantic Versioning (MAJOR.MINOR.PATCH)
- MAJOR: Breaking changes
- MINOR: New features (backwards compatible)
- PATCH: Bug fixes (backwards compatible)

### Cloud Sync
- Auto-syncs every 10 seconds when data is dirty
- DynamoDB backend with Cognito auth
- Graceful offline mode fallback
- Always update all settlements on sync

## Useful Commands

```bash
# Development
npm run dev              # Start dev server

# Testing
npm test                 # Run tests in watch mode
npm test -- [name]       # Run specific test file
npm test -- --run        # Run once without watch
npm run test:coverage    # Generate coverage report

# Building
npm run build            # Build for production
npm run preview          # Preview production build

# Type Checking
npx tsc -b               # Check TypeScript compilation

# Version Management
npm version patch        # Bump patch version (1.3.1 -> 1.3.2)
npm version minor        # Bump minor version (1.3.1 -> 1.4.0)
npm version major        # Bump major version (1.3.1 -> 2.0.0)
```

## Contact & Questions

If you encounter patterns or preferences not covered in this config:
- Ask the user for clarification
- Update this config file with the new preference
- Document the decision for future reference

---

**Last Updated:** 2026-02-11  
**Config Version:** 1.1.0  
**Changes in 1.1.0:** Added token usage tracking and reporting guidelines
